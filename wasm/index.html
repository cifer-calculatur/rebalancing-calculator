<html lang="en">
<head>
    <meta charset="utf-8"/>
    <script src="wasm_exec.js"></script>
    <script type="module" src="js/components/cifer-asset-input.js"></script>
    <script>
        async function runCalculation() {
            const categories = [];
            const assetElements = document.querySelectorAll('cifer-asset-input');
            assetElements.forEach((assetElement) => {
                const name = assetElement.name;
                const target = parseFloat(assetElement.targetAllocation);
                const current = parseFloat(assetElement.currentValue);
                categories.push({ Name: name, Target: target, Current: current });
            });

            const amountToInvest = parseFloat(document.getElementById('amount').value);

            try {
                const result = calculateRebalance(categories, amountToInvest);

                if (result instanceof Error) {
                    console.error("Error calculating rebalance:", result.message);
                } else {
                    displayResults(result);
                }
            } catch (err) {
                // Catch potential errors during the WASM call itself
                console.error("Error calling WASM function:", err);
            }
        }

        function displayResults(data) {
            document.querySelector('pre').innerText = JSON.stringify(data, null, 2);
        }

        const go = new Go();
        WebAssembly.instantiateStreaming(fetch("build/main.wasm"), go.importObject).then((result) => {
            go.run(result.instance);
        });

        window.addEventListener('load', () => {
            document.querySelector('button[name="calc"]').addEventListener('click', runCalculation);
            document.querySelector('button[name="add-asset"]').addEventListener('click', (e) => {
                e.preventDefault();
                const assetsDiv = document.querySelector('.assets');
                const assetInput = document.createElement('cifer-asset-input');
                assetInput.name = "New Asset";
                assetInput.targetAllocation = 0;
                assetInput.currentValue = 0;
                assetInput.mode = "edit";
                assetsDiv.appendChild(assetInput);
            });
        });
    </script>
    <title>CiFeR - Cash Flow Rebalancing Calculator</title>
</head>
<body>
    <fieldset>
        <legend>Asset Allocation</legend>
        <div class="assets"></div>
        <button name="add-asset">Add Asset class</button>
    </fieldset>
    <label>
        Amount to invest:
        <input type="number" id="amount" value="380.00" step="0.01"/>
    </label>
    <button name="calc">Calculate</button>
    <pre></pre>
</body>
</html>
